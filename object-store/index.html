<!DOCTYPE html>
<html lang="en">
  <head>
      
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />

      

      <title></title>

      
          <script src="https://cdn.tailwindcss.com?plugins=typography,aspect-ratio,line-clamp"></script>
          <link rel="stylesheet" href="https://amrltqt.github.io/theme.css">
      
      
  </head>
  <body>
  
    <header>
      <nav class="bg-white shadow">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div class="flex h-16 justify-between">
            <div class="flex">
              <div class="flex flex-shrink-0 items-center">
                <a href="https:&#x2F;&#x2F;amrltqt.github.io" title="AMRLQT blog" class="text-xl font-medium">AMRLQT </a>
              </div>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:items-center">
                <a itemprop="url" href="https://github.com/amrltqt">
                  <img id="avatar" src="https://amrltqt.github.io/avatar.jpg" title="https://github.com/amrltqt" />
                </a>
            </div>
          </div>
        </div>
      </nav>
    </header>
    
    <main class="container mx-auto">
      
<div class="container mx-auto lg:px-40">
    <div class="flex items-center justify-between gap-x-6 py-3 border-b border-red-900">
        <div class="min-w-0">
            <h1 class="text-2xl font-semibold leading-7 text-red-900 pb-1">Rust - Object store for newbies</h1>
        </div>
        <div class="flex flex-none items-center gap-x-4">
            <p class="text-sm text-slate-500">2022-11-11</p>
        </div>
    </div>
    <div id='content' class="mt-4">
        <p>The <a href="https://crates.io/crates/object_store">object_store</a> package is a convenient way to adress common cloud object stores.</p>
<p>Cloud object store is a simple, efficient and cheap way of storing files. Use cases goes from serving static website content to host gigabytes of files for data processing.</p>
<p>The package <a href="https://crates.io/crates/object_store">object_stores</a> that we will use today is hosted in the arrow-rs project and essentially designed to manage files used in arrow / datafusion contexts.</p>
<p>We're going to goes through the API to be able to:</p>
<ul>
<li>configure your ovh cloud storage</li>
<li>list files</li>
<li>create a new small file</li>
<li>read it back in memory</li>
<li>finally delete it</li>
</ul>
<p>Crates documentation is available <a href="https://docs.rs/object_store/latest/object_store/">here</a></p>
<h2 id="list-files">List files</h2>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#72ab00;">use </span><span>futures::stream::StreamExt;
</span><span style="color:#72ab00;">use </span><span>object_store::{aws::AmazonS3Builder, path::Path, Error, ObjectMeta, ObjectStore};
</span><span>
</span><span>async </span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">display_metadata</span><span>(</span><span style="color:#5597d6;">maybe_meta</span><span>: </span><span style="color:#a2a001;">Result</span><span>&lt;ObjectMeta, Error&gt;) {
</span><span>    </span><span style="color:#668f14;">let</span><span> meta </span><span style="color:#72ab00;">=</span><span> maybe_meta.</span><span style="color:#b39f04;">unwrap</span><span>();
</span><span>    </span><span style="color:#a2a001;">println!</span><span>(</span><span style="color:#d07711;">&quot;Name: </span><span style="color:#aeb52b;">{}</span><span style="color:#d07711;">, size: </span><span style="color:#aeb52b;">{}</span><span style="color:#d07711;">&quot;</span><span>, meta.location, meta.size);
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#5597d6;">tokio</span><span>::</span><span style="color:#5597d6;">main</span><span>]
</span><span>async </span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">main</span><span>() {
</span><span>    </span><span style="color:#668f14;">let</span><span> os </span><span style="color:#72ab00;">= </span><span>AmazonS3Builder::from_env()
</span><span>        .</span><span style="color:#b39f04;">with_bucket_name</span><span>(</span><span style="color:#d07711;">&quot;object-store-demo&quot;</span><span>)
</span><span>        .</span><span style="color:#b39f04;">build</span><span>()
</span><span>        .</span><span style="color:#b39f04;">unwrap</span><span>();
</span><span>
</span><span>    </span><span style="color:#668f14;">let</span><span> prefix </span><span style="color:#72ab00;">= </span><span>Path::from(</span><span style="color:#d07711;">&quot;data&quot;</span><span>);
</span><span>
</span><span>    os.</span><span style="color:#b39f04;">list</span><span>(</span><span style="color:#a2a001;">Some</span><span>(</span><span style="color:#72ab00;">&amp;</span><span>prefix))
</span><span>        .await
</span><span>        .</span><span style="color:#b39f04;">expect</span><span>(</span><span style="color:#d07711;">&quot;Error while listing files&quot;</span><span>)
</span><span>        .</span><span style="color:#b39f04;">for_each</span><span>(display_metadata)
</span><span>        .await;
</span><span>}
</span></code></pre>
<h2 id="create-a-new-file-object">Create a new file object</h2>
<p>You can replace the code for listing file object with the following one.
The key part of this piece of code is the ObjectStore that implements <a href="https://docs.rs/object_store/latest/object_store/trait.ObjectStore.html#required-methods">put</a> to save bytes to the target <a href="https://docs.rs/object_store/latest/object_store/path/struct.Path.html">Path</a> location.</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#668f14;">let</span><span> content </span><span style="color:#72ab00;">= </span><span style="color:#668f14;">r</span><span style="color:#d07711;">#&quot;
</span><span style="color:#d07711;">Lorem ipsum dolor sit amet, consectetur adipiscing elit,
</span><span style="color:#d07711;">sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
</span><span style="color:#d07711;">Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris
</span><span style="color:#d07711;">nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in
</span><span style="color:#d07711;">reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla
</span><span style="color:#d07711;">pariatur.&quot;#</span><span>;
</span><span>
</span><span style="color:#668f14;">let</span><span> target </span><span style="color:#72ab00;">= </span><span>Path::from(</span><span style="color:#d07711;">&quot;data/lorem_ipsum.txt&quot;</span><span>);
</span><span style="color:#72ab00;">if </span><span style="color:#668f14;">let </span><span style="color:#a2a001;">Err</span><span>(err) </span><span style="color:#72ab00;">=</span><span> os.</span><span style="color:#b39f04;">put</span><span>(</span><span style="color:#72ab00;">&amp;</span><span>target, Bytes::from(content)).await {
</span><span>    </span><span style="color:#a2a001;">panic!</span><span>(</span><span style="color:#d07711;">&quot;{}&quot;</span><span>, err);
</span><span>} </span><span style="color:#72ab00;">else </span><span>{
</span><span>    </span><span style="color:#a2a001;">println!</span><span>(</span><span style="color:#d07711;">&quot;File have been written&quot;</span><span>);
</span><span>}
</span></code></pre>
<h2 id="get-back-the-file-content">Get back the file content</h2>
<p>There are several way to capture file content. Especially with large file you should consider a <a href="https://docs.rs/object_store/latest/object_store/index.html#fetching-objects">streaming approach</a>.</p>
<p>In our example, we just poll the data in memory and convert it to an utf8 string with <a href="https://doc.rust-lang.org/stable/std/str/fn.from_utf8.html#"><code>std::str::from_utf8</code></a>.</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// Let&#39;s cut it in several steps
</span><span style="color:#668f14;">let</span><span> file </span><span style="color:#72ab00;">=</span><span> os.</span><span style="color:#b39f04;">get</span><span>(</span><span style="color:#72ab00;">&amp;</span><span>target).await.</span><span style="color:#b39f04;">unwrap</span><span>();
</span><span style="color:#668f14;">let</span><span> byte_content </span><span style="color:#72ab00;">=</span><span> file.</span><span style="color:#b39f04;">bytes</span><span>().await.</span><span style="color:#b39f04;">unwrap</span><span>();
</span><span style="color:#668f14;">let</span><span> utf8_content </span><span style="color:#72ab00;">= </span><span>std::str::from_utf8(</span><span style="color:#72ab00;">&amp;</span><span>byte_content).</span><span style="color:#b39f04;">unwrap</span><span>();
</span></code></pre>
<h2 id="delete-file-content">Delete file content.</h2>
<p>In the end, file deletion is a really simple task.</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#72ab00;">if </span><span style="color:#668f14;">let </span><span style="color:#a2a001;">Err</span><span>(err) </span><span style="color:#72ab00;">=</span><span> os.</span><span style="color:#b39f04;">delete</span><span>(</span><span style="color:#72ab00;">&amp;</span><span>target).await {
</span><span>    </span><span style="color:#a2a001;">println!</span><span>(</span><span style="color:#d07711;">&quot;Issue while deleting file object: </span><span style="color:#aeb52b;">{}</span><span style="color:#d07711;">&quot;</span><span>, err);
</span><span>};
</span></code></pre>

    </div>
</div>

    </main>
    
    <footer class="border-t border-gray-900/10 pt-4 sm:mt-20 lg:mt-24">
      
      <div class="mx-auto max-w-7xl px-6 pb-4 lg:px-8">
      <div class="text-sm leading-5 text-gray-500">
        <div class=""></div>
        <div class="">
          <small class="">
            Copyright &copy; Amrltqt
          </small>
          <small class="">
            Powered by <a href="https://www.getzola.org" target="_blank" noreferrer>Zola</a> 
          </small>
        </div>
      </div>
      </div>
      
    </footer>
  
  </body>
</html>
