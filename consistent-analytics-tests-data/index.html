<!DOCTYPE html>
<html lang="en">
  <head>
      
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />

      

      <title></title>

      
          <script src="https://cdn.tailwindcss.com?plugins=typography,aspect-ratio,line-clamp"></script>
          <link rel="stylesheet" href="https://amrltqt.github.io/theme.css">
      
      
  </head>
  <body>
  
    <header>
      <nav class="bg-white shadow">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div class="flex h-16 justify-between">
            <div class="flex">
              <div class="flex flex-shrink-0 items-center">
                <a href="https:&#x2F;&#x2F;amrltqt.github.io" title="AMRLQT blog" class="text-xl font-medium">AMRLQT </a>
              </div>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:items-center">
                <a itemprop="url" href="https://github.com/amrltqt">
                  <img id="avatar" src="https://amrltqt.github.io/avatar.jpg" title="https://github.com/amrltqt" />
                </a>
            </div>
          </div>
        </div>
      </nav>
    </header>
    
    <main class="container mx-auto">
      
<div class="container mx-auto lg:px-40">
    <div class="flex items-center justify-between gap-x-6 py-3 border-b border-red-900">
        <div class="min-w-0">
            <h1 class="text-2xl font-semibold leading-7 text-red-900 pb-1">Build a consistent test set for analytics</h1>
        </div>
        <div class="flex flex-none items-center gap-x-4">
            <p class="text-sm text-slate-500">2023-04-30</p>
        </div>
    </div>
    <div id='content' class="mt-4">
        <p>I've few algorithm that I want to test this days. For that I need several entities objects like sales, customer, products data.</p>
<p>The constraint is that, <em>obviously</em> all entities are correctly linked between each other.</p>
<p>This post will demonstrate how I build a small pipeline to:</p>
<ul>
<li>generate a consistent set of entities</li>
<li>start computing small things</li>
</ul>
<p>Let's start with a small utility file, calls it <code>utils.py</code> for example.</p>
<pre data-lang="python" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#72ab00;">import </span><span>os
</span><span style="color:#72ab00;">import </span><span>pandas </span><span style="color:#72ab00;">as </span><span>pd
</span><span>
</span><span style="color:#72ab00;">from </span><span>typing </span><span style="color:#72ab00;">import </span><span>Callable
</span><span style="color:#72ab00;">from </span><span>dotenv </span><span style="color:#72ab00;">import </span><span>load_dotenv
</span><span>
</span><span style="color:#5597d6;">load_dotenv</span><span>()
</span><span>
</span><span style="color:#5597d6;">STORAGE </span><span style="color:#72ab00;">= </span><span>os.environ.</span><span style="color:#5597d6;">get</span><span>(</span><span style="color:#d07711;">&#39;ANALYTICS_STORAGE&#39;</span><span>, </span><span style="color:#d07711;">&#39;/tmp/analytics/storage&#39;</span><span>)
</span><span>
</span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">load_dataset</span><span>(</span><span style="color:#5597d6;">name</span><span>: </span><span style="color:#a2a001;">str</span><span>):
</span><span>    dataset_file </span><span style="color:#72ab00;">= </span><span>os.path.</span><span style="color:#5597d6;">join</span><span>(</span><span style="color:#5597d6;">STORAGE</span><span>, </span><span style="color:#668f14;">f</span><span style="color:#d07711;">&quot;</span><span>{name}</span><span style="color:#d07711;">.parquet&quot;</span><span>)
</span><span>    </span><span style="color:#72ab00;">return </span><span>pd.</span><span style="color:#5597d6;">read_parquet</span><span>(dataset_file)
</span><span>
</span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">dataset</span><span>(</span><span style="color:#5597d6;">name</span><span>: </span><span style="color:#a2a001;">str</span><span>, </span><span style="color:#5597d6;">depends</span><span>: </span><span style="color:#a2a001;">list</span><span>[</span><span style="color:#a2a001;">str</span><span>] </span><span style="color:#72ab00;">| </span><span style="color:#b3933a;">None </span><span style="color:#72ab00;">= </span><span style="color:#b3933a;">None</span><span>):
</span><span>    </span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">decorator</span><span>(</span><span style="color:#5597d6;">func</span><span>: Callable[[], pd.DataFrame]):
</span><span>        </span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">wrapper</span><span>(</span><span style="color:#72ab00;">*</span><span style="color:#5597d6;">args</span><span>, </span><span style="color:#72ab00;">**</span><span style="color:#5597d6;">kwargs</span><span>):
</span><span>            </span><span style="color:#72ab00;">if </span><span>depends:
</span><span>                dependencies </span><span style="color:#72ab00;">= </span><span>[
</span><span>                    </span><span style="color:#5597d6;">load_dataset</span><span>(name)
</span><span>                    </span><span style="color:#72ab00;">for </span><span>name </span><span style="color:#72ab00;">in </span><span>depends
</span><span>                ]
</span><span>                df </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">func</span><span>(</span><span style="color:#72ab00;">*</span><span>args, </span><span style="color:#72ab00;">*</span><span>dependencies ,</span><span style="color:#72ab00;">**</span><span>kwargs)
</span><span>            </span><span style="color:#72ab00;">else</span><span>:
</span><span>                df </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">func</span><span>(</span><span style="color:#72ab00;">*</span><span>args, </span><span style="color:#72ab00;">**</span><span>kwargs)
</span><span>
</span><span>            output_file </span><span style="color:#72ab00;">= </span><span>os.path.</span><span style="color:#5597d6;">join</span><span>(</span><span style="color:#5597d6;">STORAGE</span><span>, </span><span style="color:#668f14;">f</span><span style="color:#d07711;">&quot;</span><span>{name}</span><span style="color:#d07711;">.parquet&quot;</span><span>)
</span><span>
</span><span>            </span><span style="color:#72ab00;">if not </span><span>os.path.</span><span style="color:#5597d6;">exists</span><span>(</span><span style="color:#5597d6;">STORAGE</span><span>):
</span><span>                os.</span><span style="color:#5597d6;">makedirs</span><span>(</span><span style="color:#5597d6;">STORAGE</span><span>)
</span><span>
</span><span>            df.</span><span style="color:#5597d6;">to_parquet</span><span>(output_file, </span><span style="color:#5597d6;">index</span><span style="color:#72ab00;">=</span><span style="color:#b3933a;">False</span><span>)
</span><span>
</span><span>            </span><span style="color:#72ab00;">return </span><span>df
</span><span>        </span><span style="color:#72ab00;">return </span><span>wrapper
</span><span>    </span><span style="color:#72ab00;">return </span><span>decorator
</span></code></pre>
<p>The <code>dataset</code> function is a decorator. You can use it to add behavior to your own custom functions. This one will just take the dataframe that <em>should</em> be returned by your own function and write the content in a parquet file, in a storage folder.</p>
<p>It includes a very nice feature to load dependencies of already registered dataset to inject them as a dependency for the current function.</p>
<p>Create a <code>customers.py</code> file and reuse the following content to build your own customers dataset.</p>
<pre data-lang="python" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#72ab00;">from </span><span>faker </span><span style="color:#72ab00;">import </span><span>Faker
</span><span style="color:#72ab00;">import </span><span>pandas
</span><span>
</span><span style="color:#72ab00;">from </span><span>analytics.utils </span><span style="color:#72ab00;">import </span><span>dataset
</span><span>
</span><span>@</span><span style="color:#5597d6;">dataset</span><span>(</span><span style="color:#5597d6;">name</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&#39;customers&#39;</span><span>)
</span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">generate_customers</span><span>(</span><span style="color:#5597d6;">num_customers</span><span>) -&gt; pandas.DataFrame:
</span><span>    fake </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">Faker</span><span>()
</span><span>
</span><span>    customers </span><span style="color:#72ab00;">= </span><span>[]
</span><span>    </span><span style="color:#72ab00;">for </span><span style="color:#5597d6;">_ </span><span style="color:#72ab00;">in </span><span style="color:#b39f04;">range</span><span>(num_customers):
</span><span>        name </span><span style="color:#72ab00;">= </span><span>fake.</span><span style="color:#5597d6;">company</span><span>()
</span><span>        email </span><span style="color:#72ab00;">= </span><span>fake.</span><span style="color:#5597d6;">email</span><span>()
</span><span>        phone </span><span style="color:#72ab00;">= </span><span>fake.</span><span style="color:#5597d6;">phone_number</span><span>()
</span><span>        address </span><span style="color:#72ab00;">= </span><span>fake.</span><span style="color:#5597d6;">address</span><span>()
</span><span>        country </span><span style="color:#72ab00;">= </span><span>fake.</span><span style="color:#5597d6;">country</span><span>()
</span><span>        customers.</span><span style="color:#5597d6;">append</span><span>((name, email, phone, address, country))
</span><span>
</span><span>    df </span><span style="color:#72ab00;">= </span><span>pandas.</span><span style="color:#5597d6;">DataFrame</span><span>(customers, </span><span style="color:#5597d6;">columns</span><span style="color:#72ab00;">=</span><span>[</span><span style="color:#d07711;">&#39;name&#39;</span><span>, </span><span style="color:#d07711;">&#39;email&#39;</span><span>, </span><span style="color:#d07711;">&#39;phone&#39;</span><span>, </span><span style="color:#d07711;">&#39;address&#39;</span><span>, </span><span style="color:#d07711;">&#39;country&#39;</span><span>])
</span><span>    </span><span style="color:#72ab00;">return </span><span>df
</span><span>
</span><span style="color:#72ab00;">if </span><span style="color:#a2a001;">__name__ </span><span style="color:#72ab00;">== </span><span style="color:#d07711;">&quot;__main__&quot;</span><span>:
</span><span>    </span><span style="color:#5597d6;">generate_customers</span><span>(</span><span style="color:#b3933a;">5</span><span>)
</span></code></pre>
<p>Generate the parquet file by just executing your customers scripts.</p>
<p>Add a product reference dataset.</p>
<pre data-lang="python" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#72ab00;">from </span><span>faker </span><span style="color:#72ab00;">import </span><span>Faker
</span><span style="color:#72ab00;">import </span><span>pandas </span><span style="color:#72ab00;">as </span><span>pd
</span><span style="color:#72ab00;">import </span><span>random
</span><span>
</span><span style="color:#72ab00;">from </span><span>analytics.utils </span><span style="color:#72ab00;">import </span><span>dataset
</span><span>
</span><span>@</span><span style="color:#5597d6;">dataset</span><span>(</span><span style="color:#5597d6;">name</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;products&quot;</span><span>)
</span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">generate_products</span><span>(</span><span style="color:#5597d6;">num_products</span><span>):
</span><span>    fake </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">Faker</span><span>()
</span><span>
</span><span>    categories </span><span style="color:#72ab00;">= </span><span>[</span><span style="color:#d07711;">&#39;Electronics&#39;</span><span>, </span><span style="color:#d07711;">&#39;Clothing&#39;</span><span>, </span><span style="color:#d07711;">&#39;Home&#39;</span><span>, </span><span style="color:#d07711;">&#39;Sports&#39;</span><span>, </span><span style="color:#d07711;">&#39;Books&#39;</span><span>]
</span><span>
</span><span>    products </span><span style="color:#72ab00;">= </span><span>[]
</span><span>    </span><span style="color:#72ab00;">for </span><span style="color:#5597d6;">_ </span><span style="color:#72ab00;">in </span><span style="color:#b39f04;">range</span><span>(num_products):
</span><span>        name </span><span style="color:#72ab00;">= </span><span>fake.</span><span style="color:#5597d6;">text</span><span>(</span><span style="color:#5597d6;">max_nb_chars</span><span style="color:#72ab00;">=</span><span style="color:#b3933a;">50</span><span>)
</span><span>        category </span><span style="color:#72ab00;">= </span><span>random.</span><span style="color:#5597d6;">choice</span><span>(categories)
</span><span>        price </span><span style="color:#72ab00;">= </span><span style="color:#b39f04;">round</span><span>(random.</span><span style="color:#5597d6;">uniform</span><span>(</span><span style="color:#b3933a;">10</span><span>, </span><span style="color:#b3933a;">1000</span><span>), </span><span style="color:#b3933a;">2</span><span>)
</span><span>        quantity </span><span style="color:#72ab00;">= </span><span>random.</span><span style="color:#5597d6;">randint</span><span>(</span><span style="color:#b3933a;">1</span><span>, </span><span style="color:#b3933a;">100</span><span>)
</span><span>        products.</span><span style="color:#5597d6;">append</span><span>((name, category, price, quantity))
</span><span>
</span><span>    df </span><span style="color:#72ab00;">= </span><span>pd.</span><span style="color:#5597d6;">DataFrame</span><span>(products, </span><span style="color:#5597d6;">columns</span><span style="color:#72ab00;">=</span><span>[</span><span style="color:#d07711;">&#39;name&#39;</span><span>, </span><span style="color:#d07711;">&#39;category&#39;</span><span>, </span><span style="color:#d07711;">&#39;price&#39;</span><span>, </span><span style="color:#d07711;">&#39;quantity&#39;</span><span>])
</span><span>    </span><span style="color:#72ab00;">return </span><span>df
</span><span>
</span><span>
</span><span style="color:#72ab00;">if </span><span style="color:#a2a001;">__name__ </span><span style="color:#72ab00;">== </span><span style="color:#d07711;">&quot;__main__&quot;</span><span>:
</span><span>    </span><span style="color:#5597d6;">generate_products</span><span>(</span><span style="color:#b3933a;">30</span><span>)
</span></code></pre>
<p>The challenge is to combine both of them an generates sales values.</p>
<p>We are going to introduce the dependency description there to inject product and customer in the sales generation process.</p>
<pre data-lang="python" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#72ab00;">import </span><span>pandas
</span><span style="color:#72ab00;">import </span><span>numpy </span><span style="color:#72ab00;">as </span><span>np
</span><span style="color:#72ab00;">from </span><span>faker </span><span style="color:#72ab00;">import </span><span>Faker
</span><span>
</span><span style="color:#72ab00;">from </span><span>analytics.utils </span><span style="color:#72ab00;">import </span><span>dataset
</span><span>
</span><span>@</span><span style="color:#5597d6;">dataset</span><span>(</span><span style="color:#5597d6;">name</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;sales&quot;</span><span>, </span><span style="color:#5597d6;">depends</span><span style="color:#72ab00;">=</span><span>[</span><span style="color:#d07711;">&quot;customers&quot;</span><span>, </span><span style="color:#d07711;">&quot;products&quot;</span><span>])
</span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">generate_sales</span><span>(</span><span style="color:#5597d6;">num_sales</span><span>, </span><span style="color:#5597d6;">customers_df</span><span>, </span><span style="color:#5597d6;">products_df</span><span>):
</span><span>    fake </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">Faker</span><span>()
</span><span>    sales </span><span style="color:#72ab00;">= </span><span>[]
</span><span>
</span><span>    </span><span style="color:#72ab00;">for </span><span style="color:#5597d6;">_ </span><span style="color:#72ab00;">in </span><span style="color:#b39f04;">range</span><span>(num_sales):
</span><span>        </span><span style="color:#7f8989;"># Choisir un client aléatoire
</span><span>        customer </span><span style="color:#72ab00;">= </span><span>customers_df.</span><span style="color:#5597d6;">sample</span><span>(</span><span style="color:#5597d6;">n</span><span style="color:#72ab00;">=</span><span style="color:#b3933a;">1</span><span>)
</span><span>
</span><span>        </span><span style="color:#7f8989;"># Choisir un produit aléatoire
</span><span>        product </span><span style="color:#72ab00;">= </span><span>products_df.</span><span style="color:#5597d6;">sample</span><span>(</span><span style="color:#5597d6;">n</span><span style="color:#72ab00;">=</span><span style="color:#b3933a;">1</span><span>)
</span><span>
</span><span>        </span><span style="color:#7f8989;"># Générer une date de vente aléatoire
</span><span>        date </span><span style="color:#72ab00;">= </span><span>fake.</span><span style="color:#5597d6;">date_between</span><span>(</span><span style="color:#5597d6;">start_date</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&#39;-1y&#39;</span><span>, </span><span style="color:#5597d6;">end_date</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&#39;today&#39;</span><span>)
</span><span>
</span><span>        </span><span style="color:#7f8989;"># Générer une quantité aléatoire de produit vendu
</span><span>        quantity </span><span style="color:#72ab00;">= </span><span>np.random.</span><span style="color:#5597d6;">randint</span><span>(</span><span style="color:#b3933a;">1</span><span>, </span><span style="color:#b3933a;">10</span><span>)
</span><span>
</span><span>        </span><span style="color:#7f8989;"># Calculer le montant total de la vente
</span><span>        total_amount </span><span style="color:#72ab00;">= </span><span>product[</span><span style="color:#d07711;">&#39;price&#39;</span><span>].values[</span><span style="color:#b3933a;">0</span><span>] </span><span style="color:#72ab00;">* </span><span>quantity
</span><span>
</span><span>        </span><span style="color:#7f8989;"># Ajouter les informations de vente à la liste de ventes
</span><span>        sales.</span><span style="color:#5597d6;">append</span><span>((
</span><span>            date,
</span><span>            customer[</span><span style="color:#d07711;">&#39;name&#39;</span><span>].values[</span><span style="color:#b3933a;">0</span><span>],
</span><span>            customer[</span><span style="color:#d07711;">&#39;email&#39;</span><span>].values[</span><span style="color:#b3933a;">0</span><span>],
</span><span>            product[</span><span style="color:#d07711;">&#39;name&#39;</span><span>].values[</span><span style="color:#b3933a;">0</span><span>],
</span><span>            quantity,
</span><span>            product[</span><span style="color:#d07711;">&#39;price&#39;</span><span>].values[</span><span style="color:#b3933a;">0</span><span>],
</span><span>            total_amount
</span><span>        ))
</span><span>
</span><span>    </span><span style="color:#7f8989;"># Créer un DataFrame pandas avec les informations de vente
</span><span>    df </span><span style="color:#72ab00;">= </span><span>pandas.</span><span style="color:#5597d6;">DataFrame</span><span>(sales, </span><span style="color:#5597d6;">columns</span><span style="color:#72ab00;">=</span><span>[
</span><span>        </span><span style="color:#d07711;">&#39;date&#39;</span><span>,
</span><span>        </span><span style="color:#d07711;">&#39;customer_name&#39;</span><span>,
</span><span>        </span><span style="color:#d07711;">&#39;customer_email&#39;</span><span>,
</span><span>        </span><span style="color:#d07711;">&#39;product_name&#39;</span><span>,
</span><span>        </span><span style="color:#d07711;">&#39;quantity&#39;</span><span>,
</span><span>        </span><span style="color:#d07711;">&#39;price&#39;</span><span>,
</span><span>        </span><span style="color:#d07711;">&#39;total_amount&#39;
</span><span>    ])
</span><span>
</span><span>    </span><span style="color:#72ab00;">return </span><span>df
</span><span>
</span><span style="color:#72ab00;">if </span><span style="color:#a2a001;">__name__ </span><span style="color:#72ab00;">== </span><span style="color:#d07711;">&quot;__main__&quot;</span><span>:
</span><span>    </span><span style="color:#5597d6;">generate_sales</span><span>(</span><span style="color:#b3933a;">100</span><span>)
</span></code></pre>
<p>By executing correctly the scripts you'll have a correct sales test files to start modeling.</p>
<p>Example:</p>
<pre data-lang="python" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#72ab00;">import </span><span>pandas
</span><span style="color:#72ab00;">from </span><span>analytics.utils </span><span style="color:#72ab00;">import </span><span>dataset
</span><span>
</span><span>
</span><span>@</span><span style="color:#5597d6;">dataset</span><span>(</span><span style="color:#5597d6;">name</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;customer_sales&quot;</span><span>, </span><span style="color:#5597d6;">depends</span><span style="color:#72ab00;">=</span><span>[</span><span style="color:#d07711;">&quot;sales&quot;</span><span>])
</span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">customer_sales</span><span>(</span><span style="color:#5597d6;">sales</span><span>: pandas.DataFrame):
</span><span>    customer_sales </span><span style="color:#72ab00;">= </span><span>(
</span><span>        sales[[</span><span style="color:#d07711;">&quot;customer_name&quot;</span><span>, </span><span style="color:#d07711;">&quot;total_amount&quot;</span><span>]]
</span><span>            .</span><span style="color:#5597d6;">groupby</span><span>(</span><span style="color:#d07711;">&quot;customer_name&quot;</span><span>)
</span><span>            .</span><span style="color:#5597d6;">sum</span><span>()
</span><span>    )
</span><span>
</span><span>    </span><span style="color:#72ab00;">return </span><span>customer_sales
</span><span>
</span><span>
</span><span style="color:#72ab00;">if </span><span style="color:#a2a001;">__name__ </span><span style="color:#72ab00;">== </span><span style="color:#d07711;">&quot;__main__&quot;</span><span>:
</span><span>    </span><span style="color:#5597d6;">customer_sales</span><span>()
</span></code></pre>
<p>You have now a quite correct framework to build pipelines that is fed with consistent data.</p>

    </div>
</div>

    </main>
    
    <footer class="border-t border-gray-900/10 pt-4 sm:mt-20 lg:mt-24">
      
      <div class="mx-auto max-w-7xl px-6 pb-4 lg:px-8">
      <div class="text-sm leading-5 text-gray-500">
        <div class=""></div>
        <div class="">
          <small class="">
            Copyright &copy; Amrltqt
          </small>
          <small class="">
            Powered by <a href="https://www.getzola.org" target="_blank" noreferrer>Zola</a> 
          </small>
        </div>
      </div>
      </div>
      
    </footer>
  
  </body>
</html>
