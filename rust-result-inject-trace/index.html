<!DOCTYPE html>
<html lang="en">
  <head>
      
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />

      

      <title></title>

      
          <script src="https://cdn.tailwindcss.com?plugins=typography,aspect-ratio,line-clamp"></script>
          <link rel="stylesheet" href="https://amrltqt.github.io/theme.css">
      
      
  </head>
  <body>
  
    <header>
      <nav class="bg-white shadow">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div class="flex h-16 justify-between">
            <div class="flex">
              <div class="flex flex-shrink-0 items-center">
                <a href="https:&#x2F;&#x2F;amrltqt.github.io" title="AMRLQT blog" class="text-xl font-medium">AMRLQT </a>
              </div>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:items-center">
                <a itemprop="url" href="https://github.com/amrltqt">
                  <img id="avatar" src="https://amrltqt.github.io/avatar.jpg" title="https://github.com/amrltqt" />
                </a>
            </div>
          </div>
        </div>
      </nav>
    </header>
    
    <main class="container mx-auto">
      
<div class="container mx-auto lg:px-40">
    <div class="flex items-center justify-between gap-x-6 py-3 border-b border-red-900">
        <div class="min-w-0">
            <h1 class="text-2xl font-semibold leading-7 text-red-900 pb-1">Rust - Inject a trace</h1>
        </div>
        <div class="flex flex-none items-center gap-x-4">
            <p class="text-sm text-slate-500">2022-11-14</p>
        </div>
    </div>
    <div id='content' class="mt-4">
        <p>Hard day at work, sad that days have only 24h. I want to write about a small trick inspired by javascript promise based on <a href="https://doc.rust-lang.org/std/result/enum.Result.html#method.and_then"><code>and_then</code></a>.
I recently faced an issue with an wrapper function around sqlx where I want to inject at the level of this function.
But to frankly speaking, this was that kind of single expression function that makes rust so enjoyable (scala's fellows will know).</p>
<p>Let's make an example. Imagine that the <code>check</code> function is out of my crate / package (I recently understood the diff between a crate and a packages, check <a href="https://doc.rust-lang.org/book/ch07-01-packages-and-crates.html#:~:text=The%20crate%20root%20is%20a,A%20package%20contains%20a%20Cargo.">here</a> for more information).</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#668f14;">fn </span><span style="color:#c23f31;">check</span><span>(</span><span style="color:#5597d6;">number</span><span>: </span><span style="color:#668f14;">i32</span><span>) -&gt; </span><span style="color:#a2a001;">Result</span><span>&lt;</span><span style="color:#668f14;">i32</span><span>, </span><span style="color:#72ab00;">&amp;</span><span style="color:#668f14;">&#39;static str</span><span>&gt; {
</span><span>    </span><span style="color:#72ab00;">if</span><span> number </span><span style="color:#72ab00;">== </span><span style="color:#b3933a;">7 </span><span>{
</span><span>        </span><span style="color:#72ab00;">return </span><span style="color:#a2a001;">Err</span><span>(</span><span style="color:#d07711;">&quot;bouhh&quot;</span><span>)
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#a2a001;">Ok</span><span>(number)
</span><span>}
</span><span>
</span><span>
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">handle_check</span><span>(</span><span style="color:#5597d6;">number</span><span>: </span><span style="color:#668f14;">i32</span><span>) -&gt; </span><span style="color:#a2a001;">Result</span><span>&lt;</span><span style="color:#668f14;">i32</span><span>, </span><span style="color:#72ab00;">&amp;</span><span style="color:#668f14;">&#39;static str</span><span>&gt; {
</span><span>    </span><span style="color:#b39f04;">check</span><span>(number)
</span><span>}
</span></code></pre>
<p>I have this wrapper function called handle_check that makes some glue on top of the check function.
Imagine a bit more conf plus that the check function is a big builder that you consume in an upper function.</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#668f14;">fn </span><span style="color:#c23f31;">main</span><span>() {
</span><span>    </span><span style="color:#668f14;">let</span><span> rok </span><span style="color:#72ab00;">= </span><span style="color:#b39f04;">handle_check</span><span>(</span><span style="color:#b3933a;">1</span><span>);
</span><span>    </span><span style="color:#668f14;">let</span><span> rerr </span><span style="color:#72ab00;">= </span><span style="color:#b39f04;">handle_check</span><span>(</span><span style="color:#b3933a;">7</span><span>);
</span><span>}
</span></code></pre>
<p>The question is simple, how to inject some trace in the <code>handle_check</code> elegantly ?
There are no options to do it without unwrapping the content of the result obviously. So a naive and (to me) ugly solution is to do it with a <code>match</code></p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#668f14;">fn </span><span style="color:#c23f31;">handle_check</span><span>(</span><span style="color:#5597d6;">number</span><span>: </span><span style="color:#668f14;">i32</span><span>) -&gt; </span><span style="color:#a2a001;">Result</span><span>&lt;</span><span style="color:#668f14;">i32</span><span>, </span><span style="color:#72ab00;">&amp;</span><span style="color:#668f14;">&#39;static str</span><span>&gt; {
</span><span>    </span><span style="color:#668f14;">let</span><span> r </span><span style="color:#72ab00;">= </span><span style="color:#b39f04;">check</span><span>(number);
</span><span>    </span><span style="color:#72ab00;">match</span><span> r {
</span><span>      </span><span style="color:#a2a001;">Ok</span><span>(v) </span><span style="color:#72ab00;">=&gt; </span><span style="color:#a2a001;">Ok</span><span>(v),
</span><span>      </span><span style="color:#a2a001;">Err</span><span>(err) </span><span style="color:#72ab00;">=&gt; </span><span>{
</span><span>        </span><span style="color:#a2a001;">println!</span><span>(</span><span style="color:#d07711;">&quot;log something&quot;</span><span>);
</span><span>        </span><span style="color:#a2a001;">Err</span><span>(err)
</span><span>      }
</span><span>    }
</span><span>}
</span></code></pre>
<p>A much cleaner way is again to use Result operators. They're most of use a brilliant way to express simple things simply.
Here <a href="https://doc.rust-lang.org/std/result/enum.Result.html#method.and_then"><code>and_then</code></a> or [<code>or_else</code>] make it explicit about the actions you perform in case the result is Ok or Err without loosing concision.</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#668f14;">fn </span><span style="color:#c23f31;">handle_check</span><span>(</span><span style="color:#5597d6;">number</span><span>: </span><span style="color:#668f14;">i32</span><span>) -&gt; </span><span style="color:#a2a001;">Result</span><span>&lt;</span><span style="color:#668f14;">i32</span><span>, </span><span style="color:#72ab00;">&amp;</span><span style="color:#668f14;">&#39;static str</span><span>&gt; {
</span><span>    </span><span style="color:#b39f04;">check</span><span>(number)
</span><span>      .</span><span style="color:#b39f04;">and_then</span><span>(|</span><span style="color:#5597d6;">res</span><span>| {
</span><span>          </span><span style="color:#a2a001;">println!</span><span>(</span><span style="color:#d07711;">&quot;log something good&quot;</span><span>);
</span><span>          </span><span style="color:#a2a001;">Ok</span><span>(res)
</span><span>      })
</span><span>      .</span><span style="color:#b39f04;">or_else</span><span>(|</span><span style="color:#5597d6;">err</span><span>| {
</span><span>          </span><span style="color:#a2a001;">println!</span><span>(</span><span style="color:#d07711;">&quot;log something bad&quot;</span><span>);
</span><span>          </span><span style="color:#a2a001;">Err</span><span>(err)
</span><span>      })
</span><span>}
</span></code></pre>
<p>This is not optimal, we usually want to unwrap the error / result at the good moment to avoid extra consumption.
But for tracability, it's really interesting to have the information at the good level.</p>
<p>See you!</p>

    </div>
</div>

    </main>
    
    <footer class="border-t border-gray-900/10 pt-4 sm:mt-20 lg:mt-24">
      
      <div class="mx-auto max-w-7xl px-6 pb-4 lg:px-8">
      <div class="text-sm leading-5 text-gray-500">
        <div class=""></div>
        <div class="">
          <small class="">
            Copyright &copy; Amrltqt
          </small>
          <small class="">
            Powered by <a href="https://www.getzola.org" target="_blank" noreferrer>Zola</a> 
          </small>
        </div>
      </div>
      </div>
      
    </footer>
  
  </body>
</html>
